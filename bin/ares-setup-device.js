var $jscomp={scope:{}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){if(c.get||c.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(a){return $jscomp.SYMBOL_PREFIX+(a||"")+$jscomp.symbolCounter_++};
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(a){var b=0;return $jscomp.iteratorPrototype(function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.array=$jscomp.array||{};$jscomp.iteratorFromArray=function(a,b){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var c=0,d={next:function(){if(c<a.length){var f=c++;return{value:b(f,a[f]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};
$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var f=a[d];f in c||(c[f]={});c=c[f]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6-impl","es3");
var async=require("async"),inquirer=require("inquirer"),log=require("npmlog"),nopt=require("nopt"),path=require("path"),Ssdp=require("ssdp-js"),novacom=require("./../lib/base/novacom"),commonTools=require("./../lib/base/common-tools"),version=commonTools.version,cliControl=commonTools.cliControl,help=commonTools.help,appdata=commonTools.appdata,errHndl=commonTools.errMsg,setupDevice=commonTools.setupDevice,isValidDeviceName=setupDevice.isValidDeviceName,isValidIpv4=setupDevice.isValidIpv4,isValidPort=
setupDevice.isValidPort,processName=path.basename(process.argv[1],".js");process.on("uncaughtException",function(a){log.info("uncaughtException",a.toString());log.error("uncaughtException",a.stack);cliControl.end(-1)});
var knownOpts={help:Boolean,level:"silly verbose info http warn error".split(" "),version:Boolean,list:Boolean,listfull:Boolean,add:[String,null],remove:[String,null],modify:[String,null],"default":[String,null],search:Boolean,timeout:[String,null],info:[String,Array],reset:Boolean},shortHands={h:["--help"],v:["--level","verbose"],V:["--version"],l:["--list"],F:["--listfull"],i:["--info"],a:["--add"],r:["--remove"],m:["--modify"],s:["--search"],f:["--default"],t:["--timeout"],R:["--reset"]},argv=
nopt(knownOpts,shortHands,process.argv,2);log.heading=processName;log.level=argv.level||"warn";log.verbose("argv",argv);var defaultDeviceInfo={profile:appdata.getConfig(!0).profile,type:"starfish",host:"127.0.0.1",port:22,username:"root",description:"new device description",files:"stream","default":!1},inqChoices=["add","modify"],dfChoices=["set default"],rmChoices=["remove"],totChoices=inqChoices.concat(rmChoices,dfChoices),questions=[],op;
argv.list?op=list:argv.listfull?op=listfull:argv.reset?op=reset:argv.search||argv.timeout?op=search:argv.add||argv.modify||argv.info?op=modifyDeviceInfo:argv["default"]?op=setDefaultDeviceInfo:argv.remove?op=removeDeviceInfo:argv.version?version.showVersionAndExit():argv.help?(help.display(processName,appdata.getConfig(!0).profile),cliControl.end()):op=interactiveInput;op&&version.checkNodeVersion(function(){async.series([op.bind(this)],finish)});
var _needInq=function(a){return function(b){return-1!==b.indexOf(a)}};function list(a){async.series([function(a){setupDevice.showDeviceList(a)}],function(b){a(b)})}function listfull(a){async.series([function(a){setupDevice.showDeviceListFull(a)}],function(b){a(b)})}function reset(a){async.series([function(a){appdata.resetDeviceList(a)},setupDevice.showDeviceList.bind(this)],function(b){a(b)})}
function replaceDefaultDeviceInfo(a){a&&(a.profile=a.profile||defaultDeviceInfo.profile,a.type=a.type||defaultDeviceInfo.type,a.host=a.host||defaultDeviceInfo.host,a.port=a.port||defaultDeviceInfo.port,a.username=a.username||defaultDeviceInfo.username,a.files=a.files||defaultDeviceInfo.files,a.description=a.description||defaultDeviceInfo.description,a["default"]=a["default"]||defaultDeviceInfo["default"])}
function _queryAddRemove(a,b){var c={},d=this.resolver||(this.resolver=new novacom.Resolver);"function"===typeof a&&(b=a,a=null);async.waterfall([d.load.bind(d),d.list.bind(d),function(c,b){if(!a)return b(null,c,null);var e={};a.forEach(function(a){var b=a.name+" # "+a.address,d;for(d in c)if(c[d].name===a.name){e[b]=c[d];e[b].op="modify";e[b].host=a.address;break}e[b]||(e[b]={name:a.name,host:a.address,op:"add"})});questions=[{type:"list",name:"discovered",message:"Select",choices:Object.keys(e)}];
inquirer.prompt(questions).then(function(a){b(null,c,e[a.discovered])})},function(a,b,d){var e=a.filter(function(a){return-1===a.conn.indexOf("novacom")}).map(function(a){return a.name});questions=[{type:"list",name:"op",message:"Select",choices:function(){return b?"modify"===b.op?inqChoices:["add"]:totChoices},filter:function(a){return a.toLowerCase()},"default":function(){return b&&b.op?b.op:null}},{type:"input",name:"device_name",message:"Enter Device Name:",when:function(a){return"add"===a.op},
"default":function(){return b&&b.name?b.name:null},validate:function(a){return 1>a.length?"Please enter device name.":-1!==e.indexOf(a)?"Device name is duplicated. Please use another name.":isValidDeviceName(a)?!0:"Invalid name. Please do not use letters starting with '%' or '$'."}},{type:"list",name:"device_name",message:"Select a device",choices:e,when:function(a){return-1!==["modify","remove","set default"].indexOf(a.op)&&!b}}];inquirer.prompt(questions).then(function(e){a.forEach(function(a){e.device_name===
a.name&&(c=a)});c.name=e.device_name||(b?b.name:null);c.mode=e.op||(b?b.op:null);c.host=b?b.host:c.host||null;d()})}],function(a){b(a,c)})}
function _queryDeviceInfo(a,b){var c=a.mode,d=a.name,f=this.resolver||(this.resolver=new novacom.Resolver);questions=[{type:"input",name:"ip",message:"Enter Device IP address:","default":function(){return a.host||"127.0.0.1"},validate:function(a){return isValidIpv4(a)?!0:"Incorrect ip address!"},when:function(){return _needInq(c)(inqChoices)}},{type:"input",name:"port",message:"Enter Device Port:","default":function(){return a.port||"22"},validate:function(a){return isValidPort(a)?!0:"Incorrect port number!"},
when:function(){return _needInq(c)(inqChoices)}},{type:"input",name:"user",message:"Enter ssh user:","default":function(){return a.username||"root"},when:function(){return _needInq(c)(inqChoices)}},{type:"input",name:"description",message:"Enter description:","default":function(){return a.description||"new device"},when:function(){return _needInq(c)(inqChoices)}},{type:"list",name:"auth_type",message:"Select authentication",choices:["password","ssh key"],"default":function(){var b=0;a.privateKeyName&&
(b=1);return b},when:function(){return _needInq(c)(inqChoices)}},{type:"password",name:"password",message:"Enter password:",when:function(a){return _needInq(c)(inqChoices)&&"password"===a.auth_type}},{type:"input",name:"ssh_key",message:"Enter ssh private key file name:","default":function(){return a.privateKeyName||"webos_emul"},when:function(a){return _needInq(c)(inqChoices)&&"ssh key"===a.auth_type}},{type:"input",name:"ssh_passphrase",message:"Enter key's passphrase:","default":function(){return a.passphrase||
void 0},when:function(a){return _needInq(c)(inqChoices)&&"ssh key"===a.auth_type}},{type:"confirm",name:"default",message:"Set default target ?","default":!1,when:function(){return"add"===c}},{type:"confirm",name:"confirm",message:"Save ?","default":!0}];inquirer.prompt(questions).then(function(a){if(a.confirm)log.info("setup-device#interactiveInput()","Saved!");else return log.info("setup-device#interactiveInput()","Canceled!"),b(null,{msg:"Canceled"});var e={profile:appdata.getConfig(!0).profile,
name:d,host:a.ip,port:a.port,description:a.description,username:a.user,"default":a["default"]};if("add"===c||"modify"===c)if(a.auth_type&&"password"===a.auth_type)e.password=a.password,e.privateKey="@DELETE@",e.passphrase="@DELETE@",e.privateKeyName="@DELETE@";else if(a.auth_type&&"ssh key"===a.auth_type)e.password="@DELETE@",e.privateKey={openSsh:a.ssh_key},e.passphrase=a.ssh_passphrase||"@DELETE@",e.privateKeyName="@DELETE@";else return b(errHndl.changeErrMsg("NOT_SUPPORT_AUTHTYPE",a.auth_type));
"set default"===c&&(e["default"]=!0,c="default");replaceDefaultDeviceInfo(e);e.port&&(e.port=Number(e.port));async.series([f.load.bind(f),f.modifyDeviceFile.bind(f,c,e),setupDevice.showDeviceList.bind()],function(a){if(a)return b(a);b(null,{msg:"Success to "+c+" a device!!"})})})}
function interactiveInput(a){async.waterfall([setupDevice.showDeviceList.bind(this),function(a){console.log("** You can modify the device info in the above list, or add new device.");a()},_queryAddRemove,_queryDeviceInfo],function(b,c){a(b,c)})}
function search(a){var b=new Ssdp,c=1E3*Number(argv.timeout)||5E3,d=[],f=!1;console.log("Searching...");log.verbose("search()#timeout:",c);b.start();b.onDevice(function(a){!a.headers||!a.headers.SERVER||0>a.headers.SERVER.indexOf("WebOS")||f||log.verbose("search()# %s:%s (%s)","[Discovered]",a.name,a.address)});async.waterfall([function(e){setTimeout(function(){d=b.getList().map(function(a){f=!0;return{uuid:a.headers.USN.split(":")[1],name:a.name.replace(/\s/g,"_"),address:a.address,registered:!1}});
if(0===d.length)return console.log("No devices is discovered."),a();log.verbose("search()#discovered:",d.length);e(null,d)},c)},_queryAddRemove.bind(this),_queryDeviceInfo.bind(this)],function(b){a(b)})}
function _getParams(a){a=argv[a]?[].concat(argv[a]):[];var b={};1===a.length&&-1!==a[0].indexOf("{")&&-1!==a[0].indexOf("}")&&0===(a[0].split("'").length-1)%2&&(a[0]=a[0].replace(/'/g,'"'));a.forEach(function(a){try{b=JSON.parse(a)}catch(f){try{var c=a.split("=");2===c.length?(b[c[0]]=c[1],log.info("Inserting params ",c[0]+" = "+c[1])):log.verbose("Ignoring invalid arguments:",a)}catch(e){log.verbose("Ignoring invalid arguments:",a)}}});void 0!==b["default"]&&"string"==typeof b["default"]&&(b["default"]=
"true"===b["default"]);log.info("getParams():","params:",JSON.stringify(b));return b}
function modifyDeviceInfo(a){try{var b=argv.add?"add":argv.modify?"modify":null;if(!b)return a(errHndl.changeErrMsg("INVALID_MODE"));if(argv[b].match(/^-/)||"true"===argv[b])return a(errHndl.changeErrMsg("EMPTY_VALUE","DEVICE_NAME"));var c=argv.info?_getParams("info"):_getParams(b);if(argv.info){if(0===Object.keys(c).length)return a(errHndl.changeErrMsg("EMPTY_VALUE","DEVICE_INFO"));c.name||(c.name=argv[b])}else c.name=argv[b];void 0!==c["default"]&&"modify"===b&&(log.warn("Ignoring invalid arguments : default"),
c["default"]=void 0);c.privateKey&&(c.privatekey=c.privateKey);"string"===typeof c.privatekey&&(c.privateKey=c.privatekey,c.privateKey={openSsh:c.privateKey},delete c.privatekey,c.password="@DELETE@");"undefined"!==typeof c.password&&"@DELETE@"!==c.password&&(c.privateKey="@DELETE@",c.passphrase="@DELETE@");"add"===b&&(replaceDefaultDeviceInfo(c),c.privateKey||c.password||(c.password=""));if(!isValidDeviceName(c.name))return a(errHndl.changeErrMsg("INVALID_DEVICENAME"));if(c.host&&!isValidIpv4(c.host))return a(errHndl.changeErrMsg("INVALID_VALUE",
"host",c.host));if(c.port&&!isValidPort(c.port))return a(errHndl.changeErrMsg("INVALID_VALUE","port",c.port));c.port&&(c.port=Number(c.port));c.profile||(c.profile=defaultDeviceInfo.profile);var d=this.resolver||(this.resolver=new novacom.Resolver);async.series([d.load.bind(d),d.modifyDeviceFile.bind(d,b,c),setupDevice.showDeviceList.bind(this)],function(d){if(d)return a(d);a(null,{msg:"Success to "+b+" a device named "+c.name+"!!"})})}catch(f){a(f)}}
function setDefaultDeviceInfo(a){try{if("true"===argv["default"])return a(errHndl.changeErrMsg("EMPTY_VALUE","DEVICE_NAME"));var b=this.resolver||(this.resolver=new novacom.Resolver),c={name:argv["default"],"default":!0};async.series([b.load.bind(b),b.modifyDeviceFile.bind(b,"default",c),setupDevice.showDeviceList.bind(this)],function(b){if(b)return a(b);a(null,{msg:"Success to set device named "+argv["default"]+" to default!!"})})}catch(d){a(d)}}
function removeDeviceInfo(a){try{if("true"===argv.remove)return a(errHndl.changeErrMsg("EMPTY_VALUE","DEVICE_NAME"));var b=this.resolver||(this.resolver=new novacom.Resolver),c={name:argv.remove,profile:defaultDeviceInfo.profile};async.series([b.load.bind(b),b.modifyDeviceFile.bind(b,"remove",c),setupDevice.showDeviceList.bind(this)],function(b){if(b)return a(b);a(null,{msg:"Success to remove a device named "+argv.remove+"!!"})})}catch(d){a(d)}}
function finish(a,b){a?(log.error(a.toString()),log.verbose(a.stack),cliControl.end(-1)):(log.info("finish():",b),b&&b.msg&&console.log(b.msg),cliControl.end())};
