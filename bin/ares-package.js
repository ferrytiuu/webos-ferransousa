var $jscomp={scope:{}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){if(c.get||c.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(a){return $jscomp.SYMBOL_PREFIX+(a||"")+$jscomp.symbolCounter_++};
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(a){var b=0;return $jscomp.iteratorPrototype(function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.array=$jscomp.array||{};$jscomp.iteratorFromArray=function(a,b){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var c=0,d={next:function(){if(c<a.length){var e=c++;return{value:b(e,a[e]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};
$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6-impl","es3");
var fs=require("fs"),path=require("path"),async=require("async"),log=require("npmlog"),mkdirp=require("mkdirp"),packageLib=require("../lib/package"),commonTools=require("./../lib/base/common-tools"),hasProperty=require("./../lib/util/property"),cliControl=commonTools.cliControl,version=commonTools.version,help=commonTools.help,appdata=commonTools.appdata,errHndl=commonTools.errMsg,processName=path.basename(process.argv[1],".js");
process.on("uncaughtException",function(a){log.error("uncaughtException",a.toString());log.verbose("uncaughtException",a.stack);cliControl.end(-1)});2===process.argv.length&&process.argv.splice(2,0,"--help");
function PalmPackage(){this.destination=".";this.options={};this.appCnt=0;var a={help:Boolean,"hidden-help":Boolean,version:Boolean,level:"silly verbose info http warn error".split(" "),outdir:path,check:Boolean,"no-minify":Boolean,"app-exclude":[String,Array],rom:Boolean,encrypt:Boolean,sign:String,certificate:String,force:Boolean,pkgid:String,pkgversion:String,pkginfofile:String,info:String,"info-detail":String};this.argv=require("nopt")(a,{h:"--help",hh:"--hidden-help",V:"--version",o:"--outdir",
c:"--check",n:"--no-minify",e:"--app-exclude",r:"--rom",enc:"--encrypt",s:"--sign",crt:"--certificate",f:"--force",pi:"--pkgid",pv:"--pkgversion",pf:"--pkginfofile",v:["--level","verbose"],i:"--info",I:"--info-detail"},process.argv,2);this.hiddenhelpString=["","EXTRA-OPTION",help.format("-f, --force","Make .ipk package forcibly with same file structure in APP_DIR"),help.format("","If file/directories in APP_DIR consists of the following structure"),help.format("\t (ex) APP_DIR/"),help.format("\t           +-- usr/"),
help.format("\t           +-- usr/bin"),help.format("\t           +-- usr/bin/foo"),help.format("\t           +-- etc/"),help.format("\t           +-- etc/boo.conf"),help.format("","'-f, --force' option will keep this structure in .ipk"),"",help.format("-pn, --pkgname <NAME>","Set package name"),help.format("-pv, --pkgversion <VERSION>","Set package version"),"EXAMPLES","","# Create a package although directory has no appinfo.json and no services.json","  make a ipk file which of package name is 'foopkg' and package version is '1.0.1'",
"  the following command should generate a foopkg_1.0.1.ipk",processName+" APP_DIR -f -pn foopkg -pv 1.0.1",""];log.heading=processName;log.level=this.argv.level||"warn";log.verbose("argv",this.argv);this.argv.level&&(delete this.argv.level,0===this.argv.argv.remain.length&&1===Object.keys(this.argv).length&&(this.argv.help=!0))}
PalmPackage.prototype={unsupportedOptions:{noclean:1,force:1},showUsage:function(a,b){void 0===b&&(b=0);a?help.display(processName,appdata.getConfig(!0).profile,a):help.display(processName,appdata.getConfig(!0).profile);cliControl.end(b)},checkAndShowHelp:function(){this.argv.help?this.showUsage(!1,0):this.argv["hidden-help"]&&this.showUsage(!0,0)},handleOptions:function(){this.options.level=log.level;for(var a in this.argv)this.unsupportedOptions[a]&&(this.options[a]=this.argv[a]);hasProperty(this.argv,
"minify")?this.options.minify=this.argv.minify:this.options.minify=!0;if(hasProperty(this.argv,"app-exclude")){for(var b in this.argv)"appinfo.json"===this.argv[b]&&this.finish(errHndl.changeErrMsg("NOT_EXCLUDE_APPINFO"));this.options.excludefiles=this.argv["app-exclude"]}hasProperty(this.argv,"rom")?this.options.rom=this.argv.rom:this.options.rom=!1;hasProperty(this.argv,"encrypt")?this.options.encrypt=this.argv.encrypt:this.options.encrypt=!1;hasProperty(this.argv,"sign")&&(fs.existsSync(path.resolve(this.argv.sign))||
this.finish(errHndl.changeErrMsg("NOT_EXIST_PATH",this.argv.sign)),this.options.sign=this.argv.sign);hasProperty(this.argv,"certificate")&&(fs.existsSync(path.resolve(this.argv.certificate))||this.finish(errHndl.changeErrMsg("NOT_EXIST_PATH",this.argv.certificate)),this.options.certificate=this.argv.certificate);(this.options.sign&&!this.options.certificate||this.options.certificate&&!this.options.sign)&&this.finish(errHndl.changeErrMsg("USE_WITH_OPTIONS","sign, certificate"));hasProperty(this.argv,
"pkgid")&&(this.options.pkgid=this.argv.pkgid);hasProperty(this.argv,"pkgversion")&&(this.options.pkgversion=this.argv.pkgversion);hasProperty(this.argv,"pkginfofile")&&(this.options.pkginfofile=this.argv.pkginfofile);hasProperty(this.argv,"info-detail")&&(this.options.infodetail=this.argv["info-detail"]);hasProperty(this.argv,"info")&&(this.options.info=this.argv.info)},setOutputDir:function(a){log.info("setOutputDir()");this.argv.outdir&&(this.destination=this.argv.outdir);"."===this.destination&&
(this.destination=process.cwd());fs.existsSync(this.destination)?fs.statSync(this.destination).isDirectory()||this.finish(errHndl.changeErrMsg("NOT_DIRTYPE_PATH",this.destination)):(log.verbose("setOutputDir() creating directory '"+this.destination+"' ..."),mkdirp.sync(this.destination));this.destination=fs.realpathSync(this.destination);a()},checkInputDir:function(a){log.info("checkInputDir()");this.appCnt=(new packageLib.Packager(this.options)).checkInputDirectories(this.argv.argv.remain,this.options,
a)},packageApp:function(a){log.info("packageApp()");var b=new packageLib.Packager(this.options);0===this.appCnt?hasProperty(this.options,"pkginfofile")&&hasProperty(this.options,"pkgid")?(this.finish(errHndl.changeErrMsg("NOT_USE_WITH_OPTIONS","pkginfofile, pkgid")),cliControl.end(-1)):hasProperty(this.options,"pkgid")?b.servicePackaging(this.argv.argv.remain,this.destination,this.options,a):hasProperty(this.options,"pkginfofile")?b.servicePackaging(this.argv.argv.remain,this.destination,this.options,
a):(this.finish(errHndl.changeErrMsg("USE_PKGID_PKGINFO")),cliControl.end(-1)):((hasProperty(this.options,"pkgid")||hasProperty(this.options,"pkgversion")||hasProperty(this.options,"pkginfofile"))&&this.finish(errHndl.changeErrMsg("NOT_USE_WITH_OPTIONS","pkgid, pkgversion, pkginfofile")),b.generatePackage(this.argv.argv.remain,this.destination,this.options,a))},packageProject:function(){async.series([version.checkNodeVersion,this.setOutputDir.bind(this),this.checkInputDir.bind(this),this.packageApp.bind(this)],
this.finish.bind(this))},checkApplication:function(){async.series([version.checkNodeVersion,this.checkInputDir.bind(this)],function(a){return a?this.finish(a):this.finish(null,{msg:"no problems detected"})}.bind(this))},showPkgInfo:function(){log.info("showPkgInfo()");(new packageLib.Packager(this.options)).analyzeIPK(this.options,this.finish)},finish:function(a,b){log.info("finish()");a?(log.error(a.toString()),log.verbose(a.stack),cliControl.end(-1)):(b&&b[b.length-1]&&b[b.length-1].msg?console.log(b[b.length-
1].msg):b&&b.msg&&console.log(b.msg),cliControl.end())},exec:function(){this.handleOptions();this.checkAndShowHelp();this.argv.check?this.checkApplication():this.argv.version?version.showVersionAndExit():this.argv.info||this.argv["info-detail"]?this.showPkgInfo():this.packageProject()}};var cmd=new PalmPackage;cmd.exec();
