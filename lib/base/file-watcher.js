var chokidar=require("chokidar"),path=require("path"),fs=require("fs"),npmlog=require("npmlog"),luna=require("./luna"),errHndl=require("./error-handler");
(function(){var b=npmlog;b.heading="fileWatcher";b.level="warn";var f=!1,l={log:b,watch:function(d){var a=this;b.verbose("file-watcher#watch()");var e=d.hostedurl,c=this._startWatcher(e);c.on("all",function(e,h){b.verbose("file-watcher#watch():",e,h);".reloadignore"===path.basename(h)?c.close().then(function(){b.verbose("file-watcher#watch():","ignoreListFile changed");a.watch(d)}):a._launch(d,function(a){a&&(console.log("Failed to relaunch Ares Hosted App"),b.error(a.toString()),b.verbose(a.stack))})});
c.on("error",function(a){b.error("Watcher error: "+a)});process.on("SIGINT",function(){c.close().then(function(){b.verbose("file-watcher#watch():","SIGINT is detected, watcher close",e)})})},_startWatcher:function(d){var a=this._readIgnoreList(d);b.verbose("file-watcher#_startWatcher():","ignored",a);return chokidar.watch(d,{ignored:a,ignoreInitial:!0})},_readIgnoreList:function(d){var a=path.join(d,".reloadignore");b.verbose("file-watcher#_readIgnoreList():",a);if(fs.existsSync(a))try{var e=fs.readFileSync(a,
"utf-8");b.silly("file-watcher#_readIgnoreList():","fs.readFileSync:",e);for(var c=e.split(/\r?\n/),a=0;a<c.length;a++)""===c[a]?(c.splice(a,1),a--):c[a]&&!path.isAbsolute(c[a])&&0!==c[a].indexOf("**")&&(c[a]=path.join(d,c[a]));return c}catch(k){return b.error(k),[]}else return[]},_launch:function(d,a){if(!f){f=!0;var e=d.session.getDevice().lunaAddr.launch,c=e.returnValue.split(".");luna.send(d,e,{id:d.appId,subscribe:!1,params:{}},function(a,d){b.silly("file-watcher#_launch():","Relaunch lineObj:",
a);for(var e=a,g=1;g<c.length;g++)e=e[c[g]];e?(b.verbose("file-watcher#_launch():","Relaunch success"),f=!1,d(null)):(b.verbose("file-watcher#_launch():","Relaunch failure"),f=!1,d(errHndl.changeErrMsg("INVALID_OBJECT")))},a)}}};"undefined"!==typeof module&&module.exports&&(module.exports=l)})();
