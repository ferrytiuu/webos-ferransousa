var fs=require("fs"),log=require("npmlog"),mkdirp=require("mkdirp"),path=require("path"),shelljs=require("shelljs"),Validator=require("jsonschema").Validator,clone=require("./../util/objclone"),Cli=function(){function e(b,a,c){return c&&"function"===typeof c?a?setImmediate(c,b,a):setImmediate(c,b):b||a}function l(b,a){var c={resultValue:!1,err:null},d={id:"test",type:"array",items:{$ref:"/deviceSchema"}},e=new Validator;try{if(e.addSchema(b,"/deviceSchema"),(c=e.validate(a,d))&&0<c.errors.length){var d=
"Invalid device info.",g;for(g in c.errors){var d=d.concat("\n"),f=c.errors[g].property+" "+c.errors[g].message;null!=(c=/instance\[*.*\]*\./g.exec(f))&&(f=f.substring(c[0].length));d=d.concat(f)}c.err=Error(d)}else c.resultValue=!0}catch(h){c.err=h}return c}function m(){if(k)return k;k=this;if(!this.inialized){var b=path.resolve(process.env.APPDATA||process.env.HOME||process.env.USERPROFILE),a={config:{dir:path.join(__dirname,"../../files","conf"),file:"config.json"},commands:{dir:path.join(__dirname,
"../../files","conf"),file:"command-service.json"},deviceList:{dir:path.join(__dirname,"../../files","conf"),file:"novacom-devices.json"},deviceListSchema:{dir:path.join(__dirname,"../../files","schema"),file:"NovacomDevices.schema"},template:{dir:path.join(__dirname,"../../files","conf"),file:"template.json"}},c=path.join(__dirname,"../../files/conf/query"),d;for(d in a){var e=path.join(a[d].dir,a[d].file),g=d;this[g]=JSON.parse(fs.readFileSync(e));this[g+"File"]=e}b=this.config.dataDir?path.join(b,
this.config.dataDir):path.join(b,".webos");d=path.join(a.deviceList.dir,a.deviceList.file);a=path.join(b,a.deviceList.file);fs.existsSync(b)||mkdirp.sync(b);try{var f=JSON.parse(fs.readFileSync(a)),h=l(this.deviceListSchema,f);h&&h.resultValue?this.deviceList=f:(log.verbose("cliAppData()#init():","schema check failure:",a),log.verbose("cliAppData()#init():","result:",h),log.verbose("cliAppData()#init():","copy "+d+" to "+a),shelljs.cp("-f",d,a))}catch(n){log.verbose("cliAppData()#init():","err:",
n),log.verbose("cliAppData()#init():","copy "+d+" to "+a),shelljs.cp("-f",d,a)}this.builtinDeviceListFile=d;this.deviceListFile=a;this.workDir=b;this.queryPath=c;this.inialized=!0}}var k;m.prototype={getConfig:function(b){return e(null,clone(this.config),b)},getDeviceList:function(b,a){return e(null,clone(this.deviceList),a)},getCommandService:function(b){return e(null,clone(this.commands),b)},setDeviceList:function(b,a){try{var c=l(this.deviceListSchema,b);if(c&&!c.resultValue)return e(c.err||"invalid data",
this.deviceList,a);this.deviceList=b;fs.writeFileSync(this.deviceListFile,JSON.stringify(this.deviceList,null,Number(4)))}catch(d){return e(d,this.deviceList,a)}return e(null,this.deviceList,a)},setConfig:function(b,a){try{this.config=b,fs.writeFileSync(this.configFile,JSON.stringify(this.config,null,Number(4)))}catch(c){return e(c,this.config,a)}return e(null,this.config,a)},setTemplate:function(b,a){try{this.template=b,fs.writeFileSync(this.templateFile,JSON.stringify(this.template,null,Number(4)))}catch(c){return e(c,
this.template,a)}},setQuery:function(b,a){try{fs.existsSync(this.queryPath)?shelljs.ls(this.queryPath).forEach(function(a){shelljs.rm(path.join(__dirname,"../../files/conf/query",a))}):fs.mkdirSync(this.queryPath),shelljs.ls(b+"/*.json").forEach(function(a){shelljs.cp(a,path.join(__dirname,"../../files/conf","query"))})}catch(c){return e(c,this.queryPath,a)}return e(null,this.queryPath,a)},resetDeviceList:function(b){log.verbose("cliAppData#resetDeviceList()");try{fs.existsSync(this.deviceListFile)&&
shelljs.rm(this.deviceListFile),shelljs.cp(this.builtinDeviceListFile,this.deviceListFile),this.deviceList=JSON.parse(fs.readFileSync(this.deviceListFile))}catch(a){return log.verbose("cliAppData()#resetDeviceList():","err:",a),e(a,clone(this.deviceList),b)}return e(null,clone(this.deviceList),b)}};return m}();"undefined"!==typeof module&&module.exports&&(module.exports=Cli);
