var npmlog=require("npmlog"),Eof=require("../util/eof"),errHndl=require("./error-handler");
(function(){var e=npmlog;e.heading="luna";e.level="http";var q={send:function(b,c,k,m,g){function n(a){f+=a;try{d=JSON.parse(f),f="",e.verbose("luna#send()","response:",d),!1===d.returnValue?(h.destroy(),g(errHndl.changeErrMsg("FAILED_CALL_LUNA",d.errorText?d.errorText:d.errorMessage?d.errorMessage:""))):m(d,function(a,b){a&&e.verbose("luna#send()","err:",a.toString());if(a||b)e.verbose("luna#send()","closing exec stream"),g(a,b)})}catch(p){}}var l=b&&b.session,h=new Eof,d;h.pause();c=["luna:/",c.service,
c.folder,c.method].join("/");e.verbose("luna#send()","calling:",c+" '"+JSON.stringify(k)+"'");b=b&&b.nReplies?"-n "+b.nReplies+" ":"-i ";var f="";l.run(l.getDevice().lunaSend+" "+b+c+" '"+JSON.stringify(k)+"'",h,function(a){(Buffer.isBuffer(a)?a.toString():a).split(/\r?\n/).forEach(n)},process.stderr,function(a){a&&g(a)})},sendWithoutErrorHandle:function(b,c,k,m,g){function n(a){f+=a;try{d=JSON.parse(f),f="",e.verbose("luna#send()","response:",d),m(d,function(a,b){if(a||b)e.verbose("luna#send()",
"closing exec stream"),g(a,b)})}catch(p){}}var l=b&&b.session,h=new Eof,d;h.pause();c=["luna:/",c.service,c.folder,c.method].join("/");e.verbose("luna#send()","calling:",c+" '"+JSON.stringify(k)+"'");b=b&&b.nReplies?"-n "+b.nReplies+" ":"-i ";var f="";l.run(l.getDevice().lunaSend+" "+b+c+" '"+JSON.stringify(k)+"'",h,function(a){(Buffer.isBuffer(a)?a.toString():a).split(/\r?\n/).forEach(n);e.verbose("luna#send()","_onData:")},process.stderr,function(a){a&&g(a)})}};"undefined"!==typeof module&&module.exports&&
(module.exports=q)})();
